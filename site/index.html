<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="None" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Centra Scheduling Documentation</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Welcome to the Centra Scheduling Documentation";
        var mkdocs_page_input_path = "index.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="." class="icon icon-home"> Centra Scheduling Documentation
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Welcome to the Centra Scheduling Documentation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#project-description">Project Description</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#the-duration-model">The Duration Model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-scheduler">The Scheduler</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-simulator">The Simulator</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-dashboard">The Dashboard</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scheduler">scheduler</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scheduler.TaskScheduler">TaskScheduler</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.add_task">add_task</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.dump_schedule">dump_schedule</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.find_available_slot">find_available_slot</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.handle_new_task">handle_new_task</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.is_time_slot_available">is_time_slot_available</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.optimize_duration">optimize_duration</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.schedule_tasks">schedule_tasks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scheduler.TaskScheduler.update_compatibility_matrix">update_compatibility_matrix</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulator">simulator</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#simulator.ScheduleSimulator">ScheduleSimulator</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#simulator.ScheduleSimulator.__init__">__init__</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#simulator.ScheduleSimulator.run">run</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href=".">Centra Scheduling Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Welcome to the Centra Scheduling Documentation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="welcome-to-the-centra-scheduling-documentation">Welcome to the Centra Scheduling Documentation</h1>
<h2 id="project-description">Project Description</h2>
<p>This site documents a capstone project completed by Devan Walhof, Kaden Skarda, Henry Thomas, 
and John Hutchinson of Liberty University for Centra in an effort to increase utilization by
improving scheduling. The project consists of several components:</p>
<h3 id="the-duration-model">The Duration Model</h3>
<p>The duration model estimates the length of an appointment based on historical data. 
It estimates the duration by fitting kernel density estimation on the lengths of 
appointments separated by appointment type and doctor. This allows a probabilistic 
prediction of the duration of future appointments for that appointment type and doctor 
in the future.</p>
<h3 id="the-scheduler">The Scheduler</h3>
<p>The scheduler uses the duration model and then assigns patients to doctors based on which 
doctors are available and any imposed constraints - i.e. patient x can only see doctor y.<br />
It uses a heuristic greedy algorithm of simply scheduling patients with the first available
doctor that can handle an appointment of the length estimated by the duration model.</p>
<h3 id="the-simulator">The Simulator</h3>
<p>The simulator tests the scheduler and the duration model by finding their metrics on historical
data. It calculates these metrics by using a scheduling model to create a schedule and then 
finding the realizations of this schedule based on the actual durations of the appointments.
It allows testing of the viability of different scheduling models, both against each other and 
against the baseline.  </p>
<h3 id="the-dashboard">The Dashboard</h3>
<p>The dashboard conveys the scheduling model to the consumer. It allows users to input
data about the appointment type and receive a predicted duration and suggested appointment 
times, along with relevant reporting and descriptive statistics. </p>


<div class="doc doc-object doc-module">



<a id="scheduler"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="scheduler.TaskScheduler" class="doc doc-heading">
            <code>TaskScheduler</code>


</h2>


    <div class="doc doc-contents ">


              <details class="quote">
                <summary>Source code in <code>scheduler.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TaskScheduler</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">num_time_slots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">slot_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">estimation_mode</span><span class="o">=</span><span class="s2">&quot;distribution&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param machines: the available machines</span>
<span class="sd">        :param num_time_slots: the number of time slots to include in the future for scheduling</span>
<span class="sd">        :param current_schedule:</span>
<span class="sd">        :param alpha: weight to determine the relationship between machine idle time and part wait time</span>
<span class="sd">        :param slot_size: the length of the basic scheduling block</span>
<span class="sd">        :param estimation_mode: determines the input type for calculated the expected time. Can be &#39;distribution&#39; for</span>
<span class="sd">        scipy.stats distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">machines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span> <span class="o">=</span> <span class="n">service_time_distributions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_time_slot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span> <span class="o">=</span> <span class="n">num_time_slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">]</span>  <span class="c1"># Schedule for each machine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Priority queue for incoming tasks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot_size</span> <span class="o">=</span> <span class="n">slot_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_mode</span> <span class="o">=</span> <span class="n">estimation_mode</span>

    <span class="k">def</span> <span class="nf">update_compatibility_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compatible_machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the compatibility matrix with a row for each task. The compatibility matrix is an array row indexed by</span>
<span class="sd">        task and column indexed by machines with an entry of 1 where the machine is compatible and 0 if it is not.</span>

<span class="sd">        :param compatible_machines: list</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">compatible_machines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">compatible_machines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compatible_machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new task given a priority and what machines can service it.</span>

<span class="sd">        :param priority: the importance of the task, lower is better</span>
<span class="sd">        :param compatible_machines: list of machines that can handle the task</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add a new task to the priority queue</span>
        <span class="n">current_task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">,</span> <span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">current_task_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_compatibility_matrix</span><span class="p">(</span><span class="n">compatible_machines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">optimize_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the optimal number of blocks to schedule for the task</span>
<span class="sd">        :param task_id: The id of the task to schedule</span>
<span class="sd">        :return: opt_duration: The number of blocks that minimizes the objective function</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">opt_duration</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">opt_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># the weighted expected value for the best duration</span>

        <span class="c1"># find the service time that optimizes the weighted sum of idle and wait time</span>
        <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_lengths</span><span class="p">:</span>
            <span class="n">allotted_service_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_size</span> <span class="o">*</span> <span class="n">duration</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="n">machine_idle_time</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">allotted_service_time</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="p">[</span><span class="n">task_id</span><span class="p">],</span>
                                            <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">allotted_service_time</span><span class="p">)</span>
            <span class="n">wait_time</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">allotted_service_time</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">allotted_service_time</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">machine_idle_time</span> <span class="o">+</span> <span class="n">wait_time</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">opt_z</span><span class="p">:</span>
                <span class="n">opt_duration</span> <span class="o">=</span> <span class="n">duration</span>
                <span class="n">opt_z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">return</span> <span class="n">opt_duration</span>

    <span class="c1"># possibly change the distribution to accommodate different service times for different machines</span>
    <span class="k">def</span> <span class="nf">find_available_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the duration of the appointment by optimizing the tradeoff between machine idle time and part times given</span>
<span class="sd">        the current alpha</span>

<span class="sd">        :param machine_id: the id of the machine servicing the task</span>
<span class="sd">        :param task_id: the id of the task being scheduled</span>
<span class="sd">        :return: start_time, end_time_slot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find the first available time slot on a given machine for the new task</span>
        <span class="k">for</span> <span class="n">start_time</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_slot_available</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
                <span class="n">opt_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_duration</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
                <span class="n">end_time_slot</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">opt_duration</span>

                <span class="k">if</span> <span class="n">end_time_slot</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_time_slot_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether a machine is available at a certain time</span>

<span class="sd">        :param machine_id: the id of the machine servicing the task</span>
<span class="sd">        :param start_time: the beginning of the service</span>
<span class="sd">        :param end_time_slot: the end of the service</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if a time slot is available for the new task</span>

        <span class="c1"># Check if the start and end times conflict with existing tasks</span>
        <span class="k">for</span> <span class="n">scheduled_task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">machine_id</span><span class="p">]:</span>
            <span class="n">scheduled_start</span><span class="p">,</span> <span class="n">scheduled_end</span> <span class="o">=</span> <span class="n">scheduled_task</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scheduled_task</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">end_time_slot</span> <span class="o">&lt;=</span> <span class="n">scheduled_start</span> <span class="ow">or</span> <span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">scheduled_end</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">schedule_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">min_idle_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">best_schedule</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Consider all machines</span>
        <span class="k">for</span> <span class="n">machine_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">)):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span><span class="p">[</span><span class="n">task_id</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Find the first available time slot on the machine</span>
            <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_available_slot</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">idle_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_slot</span>
                <span class="k">if</span> <span class="n">idle_time</span> <span class="o">&lt;</span> <span class="n">min_idle_time</span><span class="p">:</span>
                    <span class="n">min_idle_time</span> <span class="o">=</span> <span class="n">idle_time</span>
                    <span class="n">best_schedule</span> <span class="o">=</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_schedule</span><span class="p">:</span>
            <span class="n">task_id</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span> <span class="o">=</span> <span class="n">best_schedule</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">machine_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">task_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_time_slot</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time_slot</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduled Task </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2"> on Machine </span><span class="si">{</span><span class="n">machine_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">start_time</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end_time_slot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to schedule </span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_new_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new task to the schedule</span>
<span class="sd">        :param task: instance of Task dataclass</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># When a new task arrives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">distribution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">failure_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">compatible_machines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_tasks</span><span class="p">()</span>
        <span class="c1"># print(self.schedule)</span>

    <span class="k">def</span> <span class="nf">schedule_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule each task in the queue</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">task_id</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump the schedule into a file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">))}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="k">return</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">machines</span><span class="p">,</span> <span class="n">num_time_slots</span><span class="p">,</span> <span class="n">current_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">slot_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">estimation_mode</span><span class="o">=</span><span class="s1">&#39;distribution&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>:param machines: the available machines
:param num_time_slots: the number of time slots to include in the future for scheduling
:param current_schedule:
:param alpha: weight to determine the relationship between machine idle time and part wait time
:param slot_size: the length of the basic scheduling block
:param estimation_mode: determines the input type for calculated the expected time. Can be 'distribution' for
scipy.stats distribution</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">num_time_slots</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">current_schedule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">slot_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
             <span class="n">estimation_mode</span><span class="o">=</span><span class="s2">&quot;distribution&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param machines: the available machines</span>
<span class="sd">    :param num_time_slots: the number of time slots to include in the future for scheduling</span>
<span class="sd">    :param current_schedule:</span>
<span class="sd">    :param alpha: weight to determine the relationship between machine idle time and part wait time</span>
<span class="sd">    :param slot_size: the length of the basic scheduling block</span>
<span class="sd">    :param estimation_mode: determines the input type for calculated the expected time. Can be &#39;distribution&#39; for</span>
<span class="sd">    scipy.stats distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">machines</span> <span class="o">=</span> <span class="n">machines</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span> <span class="o">=</span> <span class="n">service_time_distributions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_time_slot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span> <span class="o">=</span> <span class="n">num_time_slots</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">]</span>  <span class="c1"># Schedule for each machine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Priority queue for incoming tasks</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">service_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">slot_size</span> <span class="o">=</span> <span class="n">slot_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">estimation_mode</span> <span class="o">=</span> <span class="n">estimation_mode</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.add_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_task</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">compatible_machines</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Adds a new task given a priority and what machines can service it.</p>
<p>:param priority: the importance of the task, lower is better
:param compatible_machines: list of machines that can handle the task
:return: None</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">compatible_machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new task given a priority and what machines can service it.</span>

<span class="sd">    :param priority: the importance of the task, lower is better</span>
<span class="sd">    :param compatible_machines: list of machines that can handle the task</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add a new task to the priority queue</span>
    <span class="n">current_task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">,</span> <span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="n">current_task_id</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_compatibility_matrix</span><span class="p">(</span><span class="n">compatible_machines</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">last_task_id</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.dump_schedule" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dump_schedule</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Dump the schedule into a file
:return:</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dump_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump the schedule into a file</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">))}</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.find_available_slot" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">find_available_slot</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Finds the duration of the appointment by optimizing the tradeoff between machine idle time and part times given
the current alpha</p>
<p>:param machine_id: the id of the machine servicing the task
:param task_id: the id of the task being scheduled
:return: start_time, end_time_slot</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">find_available_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the duration of the appointment by optimizing the tradeoff between machine idle time and part times given</span>
<span class="sd">    the current alpha</span>

<span class="sd">    :param machine_id: the id of the machine servicing the task</span>
<span class="sd">    :param task_id: the id of the task being scheduled</span>
<span class="sd">    :return: start_time, end_time_slot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the first available time slot on a given machine for the new task</span>
    <span class="k">for</span> <span class="n">start_time</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_time_slot_available</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
            <span class="n">opt_duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_duration</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="n">end_time_slot</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">opt_duration</span>

            <span class="k">if</span> <span class="n">end_time_slot</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_time_slots</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.handle_new_task" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_new_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Adds a new task to the schedule
:param task: instance of Task dataclass
:return: None</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">handle_new_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new task to the schedule</span>
<span class="sd">    :param task: instance of Task dataclass</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># When a new task arrives</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">distribution</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">failure_rate</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">priority</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">compatible_machines</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule_tasks</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.is_time_slot_available" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_time_slot_available</span><span class="p">(</span><span class="n">machine_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Checks whether a machine is available at a certain time</p>
<p>:param machine_id: the id of the machine servicing the task
:param start_time: the beginning of the service
:param end_time_slot: the end of the service
:return: bool</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_time_slot_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_time_slot</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether a machine is available at a certain time</span>

<span class="sd">    :param machine_id: the id of the machine servicing the task</span>
<span class="sd">    :param start_time: the beginning of the service</span>
<span class="sd">    :param end_time_slot: the end of the service</span>
<span class="sd">    :return: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if a time slot is available for the new task</span>

    <span class="c1"># Check if the start and end times conflict with existing tasks</span>
    <span class="k">for</span> <span class="n">scheduled_task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">[</span><span class="n">machine_id</span><span class="p">]:</span>
        <span class="n">scheduled_start</span><span class="p">,</span> <span class="n">scheduled_end</span> <span class="o">=</span> <span class="n">scheduled_task</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scheduled_task</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">end_time_slot</span> <span class="o">&lt;=</span> <span class="n">scheduled_start</span> <span class="ow">or</span> <span class="n">start_time</span> <span class="o">&gt;=</span> <span class="n">scheduled_end</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.optimize_duration" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize_duration</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Finds the optimal number of blocks to schedule for the task
:param task_id: The id of the task to schedule
:return: opt_duration: The number of blocks that minimizes the objective function</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optimize_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the optimal number of blocks to schedule for the task</span>
<span class="sd">    :param task_id: The id of the task to schedule</span>
<span class="sd">    :return: opt_duration: The number of blocks that minimizes the objective function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">opt_duration</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">opt_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># the weighted expected value for the best duration</span>

    <span class="c1"># find the service time that optimizes the weighted sum of idle and wait time</span>
    <span class="k">for</span> <span class="n">duration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_lengths</span><span class="p">:</span>
        <span class="n">allotted_service_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot_size</span> <span class="o">*</span> <span class="n">duration</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_time_distributions</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
        <span class="n">machine_idle_time</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">allotted_service_time</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="p">[</span><span class="n">task_id</span><span class="p">],</span>
                                        <span class="n">lb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">allotted_service_time</span><span class="p">)</span>
        <span class="n">wait_time</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_rates</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">-</span> <span class="n">allotted_service_time</span><span class="p">,</span> <span class="n">lb</span><span class="o">=</span><span class="n">allotted_service_time</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">machine_idle_time</span> <span class="o">+</span> <span class="n">wait_time</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="n">opt_z</span><span class="p">:</span>
            <span class="n">opt_duration</span> <span class="o">=</span> <span class="n">duration</span>
            <span class="n">opt_z</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">opt_duration</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.schedule_tasks" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">schedule_tasks</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Schedule each task in the queue
:return:</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">schedule_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Schedule each task in the queue</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">task_id</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule_task</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scheduler.TaskScheduler.update_compatibility_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_compatibility_matrix</span><span class="p">(</span><span class="n">compatible_machines</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Updates the compatibility matrix with a row for each task. The compatibility matrix is an array row indexed by
task and column indexed by machines with an entry of 1 where the machine is compatible and 0 if it is not.</p>
<p>:param compatible_machines: list
:return: None</p>

            <details class="quote">
              <summary>Source code in <code>scheduler.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_compatibility_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compatible_machines</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the compatibility matrix with a row for each task. The compatibility matrix is an array row indexed by</span>
<span class="sd">    task and column indexed by machines with an entry of 1 where the machine is compatible and 0 if it is not.</span>

<span class="sd">    :param compatible_machines: list</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">compatible_machines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compatibility</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">compatible_machines</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">machines</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="simulator"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="simulator.ScheduleSimulator" class="doc doc-heading">
            <code>ScheduleSimulator</code>


</h2>


    <div class="doc doc-contents ">


              <details class="quote">
                <summary>Source code in <code>simulator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ScheduleSimulator</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the simulator with a scheduling model.</span>

<span class="sd">        :param model: A function that returns a DataFrame with scheduled appointments.</span>
<span class="sd">                      The DataFrame should have columns [&#39;appointment_id&#39;, &#39;machine&#39;, &#39;start_time&#39;, &#39;end_time&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To hold the schedule once it&#39;s generated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To hold performance metrics</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appointments</span><span class="p">,</span> <span class="n">actual_durations</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the simulation, scheduling the appointments and calculating performance metrics.</span>

<span class="sd">        :param appointments: DataFrame of appointments (only has &#39;appointment_id&#39; and &#39;machine&#39;).</span>
<span class="sd">                            The start and end times will be filled in by the model.</span>
<span class="sd">        :param actual_durations: DataFrame of the actual durations for each machine.</span>
<span class="sd">                                 It should have columns [&#39;appointment_id&#39;, &#39;machine&#39;, &#39;duration&#39;].</span>

<span class="sd">        :return: results: Dictionary of performance metrics in a DataFrame format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate the schedule using the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">appointments</span><span class="p">)</span>

        <span class="c1"># Merge appointments with actual durations</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">actual_durations</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;appointment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate the actual start and end times</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_actual_times</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>

        <span class="c1"># Metrics Calculation</span>
        <span class="n">utilization</span><span class="p">,</span> <span class="n">idle_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_utilization</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">scheduling_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_scheduling_accuracy</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">total_wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_total_wait_time</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">avg_wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_average_wait_time</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">task_completion_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_task_completion_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">makespan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_makespan</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">overutilization_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overutilization_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">underutilization_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_underutilization_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">load_balancing_efficiency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_load_balancing_efficiency</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">task_bumping_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_task_bumping_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_jitter</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">end_time_deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_end_time_deviation</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>

        <span class="c1"># Store the results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;utilization&#39;</span><span class="p">:</span> <span class="n">utilization</span><span class="p">,</span>
            <span class="s1">&#39;idle_time&#39;</span><span class="p">:</span> <span class="n">idle_time</span><span class="p">,</span>
            <span class="s1">&#39;scheduling_accuracy&#39;</span><span class="p">:</span> <span class="n">scheduling_accuracy</span><span class="p">,</span>
            <span class="s1">&#39;total_wait_time&#39;</span><span class="p">:</span> <span class="n">total_wait_time</span><span class="p">,</span>
            <span class="s1">&#39;average_wait_time&#39;</span><span class="p">:</span> <span class="n">avg_wait_time</span><span class="p">,</span>
            <span class="s1">&#39;task_completion_rate&#39;</span><span class="p">:</span> <span class="n">task_completion_rate</span><span class="p">,</span>
            <span class="s1">&#39;makespan&#39;</span><span class="p">:</span> <span class="n">makespan</span><span class="p">,</span>
            <span class="s1">&#39;overutilization_rate&#39;</span><span class="p">:</span> <span class="n">overutilization_rate</span><span class="p">,</span>
            <span class="s1">&#39;underutilization_rate&#39;</span><span class="p">:</span> <span class="n">underutilization_rate</span><span class="p">,</span>
            <span class="s1">&#39;load_balancing_efficiency&#39;</span><span class="p">:</span> <span class="n">load_balancing_efficiency</span><span class="p">,</span>
            <span class="s1">&#39;task_bumping_rate&#39;</span><span class="p">:</span> <span class="n">task_bumping_rate</span><span class="p">,</span>
            <span class="s1">&#39;jitter&#39;</span><span class="p">:</span> <span class="n">jitter</span><span class="p">,</span>
            <span class="s1">&#39;end_time_deviation&#39;</span><span class="p">:</span> <span class="n">end_time_deviation</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Metric&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_actual_times</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the actual start and end times based on durations and machine availability.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled appointments and actual durations.</span>

<span class="sd">        :return: merged_df: Updated DataFrame with actual start and end times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Track machine availability (i.e., when the machine is next free)</span>
        <span class="n">machine_availability</span> <span class="o">=</span> <span class="p">{</span><span class="n">machine</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-10-01 00:00&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span>
            <span class="n">scheduled_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">])</span>

            <span class="c1"># Calculate actual start time as the max of scheduled start or when the machine becomes available</span>
            <span class="n">actual_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scheduled_start</span><span class="p">,</span> <span class="n">machine_availability</span><span class="p">[</span><span class="n">machine</span><span class="p">])</span>
            <span class="n">actual_end</span> <span class="o">=</span> <span class="n">actual_start</span> <span class="o">+</span> <span class="n">duration</span>

            <span class="c1"># Update the machine availability to reflect the new end time</span>
            <span class="n">machine_availability</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_end</span>

            <span class="c1"># Assign the actual start and end times back to the DataFrame</span>
            <span class="n">merged_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;actual_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_start</span>
            <span class="n">merged_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;actual_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_end</span>

        <span class="k">return</span> <span class="n">merged_df</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_utilization</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate machine utilization and idle time based on actual appointments.</span>

<span class="sd">        Utilization is the percentage of time that machines were actively working on tasks</span>
<span class="sd">        compared to the total available time. Idle time is the amount of time machines</span>
<span class="sd">        were not used.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: tuple (utilization, idle_time):</span>
<span class="sd">                 - utilization: The percentage of time machines were in use.</span>
<span class="sd">                 - idle_time: The amount of time machines were idle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_of_day</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">end_of_day</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">total_time_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_of_day</span> <span class="o">-</span> <span class="n">start_of_day</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>  <span class="c1"># Total minutes in the schedule</span>

        <span class="n">machine_metrics</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">machine_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">machine</span><span class="p">]</span>
            <span class="n">total_machine_time</span> <span class="o">=</span> <span class="n">total_time_period</span>  <span class="c1"># Total time available for each machine</span>

            <span class="c1"># Calculate actual usage</span>
            <span class="n">actual_usage</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">machine_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">actual_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span>
                <span class="n">actual_end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_start</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_end</span><span class="p">):</span>
                    <span class="n">actual_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_end</span> <span class="o">-</span> <span class="n">actual_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                    <span class="n">actual_usage</span> <span class="o">+=</span> <span class="n">actual_duration</span>

            <span class="n">utilization</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_usage</span> <span class="o">/</span> <span class="n">total_machine_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">idle_time</span> <span class="o">=</span> <span class="n">total_machine_time</span> <span class="o">-</span> <span class="n">actual_usage</span>
            <span class="n">machine_metrics</span><span class="p">[</span><span class="n">machine</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;utilization&#39;</span><span class="p">:</span> <span class="n">utilization</span><span class="p">,</span> <span class="s1">&#39;idle_time&#39;</span><span class="p">:</span> <span class="n">idle_time</span><span class="p">}</span>

        <span class="c1"># Total utilization and idle time</span>
        <span class="n">total_actual_usage</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;utilization&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_time_period</span> <span class="o">/</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">machine_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">total_utilization</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_actual_usage</span> <span class="o">/</span> <span class="p">(</span><span class="n">total_time_period</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine_metrics</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">total_idle_time</span> <span class="o">=</span> <span class="n">total_time_period</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine_metrics</span><span class="p">)</span> <span class="o">-</span> <span class="n">total_actual_usage</span>

        <span class="k">return</span> <span class="n">total_utilization</span><span class="p">,</span> <span class="n">total_idle_time</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_scheduling_accuracy</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate how closely the scheduled appointments matched the actual times.</span>
<span class="sd">        Scheduling accuracy measures the extent to which the actual start and end times of tasks</span>
<span class="sd">        fall within the scheduled times. A higher accuracy indicates better scheduling performance.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>
<span class="sd">        :return: accuracy: The percentage of appointments that were scheduled correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">scheduled_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">scheduled_end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
            <span class="n">actual_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span>
            <span class="n">actual_end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_start</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_end</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">scheduled_start</span> <span class="o">&lt;=</span> <span class="n">actual_start</span> <span class="o">&lt;=</span> <span class="n">scheduled_end</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">scheduled_start</span> <span class="o">&lt;=</span> <span class="n">actual_end</span> <span class="o">&lt;=</span> <span class="n">scheduled_end</span><span class="p">):</span>
                <span class="n">correct</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">accuracy</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_total_wait_time</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the total wait time for all tasks that started after their scheduled time.</span>
<span class="sd">        Total wait time sums the differences between actual start times and scheduled start times</span>
<span class="sd">        for all tasks that were delayed. This metric can help identify delays in the scheduling process.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>
<span class="sd">        :return: total_wait_time: The total wait time in minutes for all appointments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_wait_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">scheduled_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>
            <span class="n">actual_start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">actual_start</span> <span class="o">&gt;</span> <span class="n">scheduled_start</span><span class="p">:</span>
                <span class="n">wait_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_start</span> <span class="o">-</span> <span class="n">scheduled_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="n">total_wait_time</span> <span class="o">+=</span> <span class="n">wait_time</span>

        <span class="k">return</span> <span class="n">total_wait_time</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_average_wait_time</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the average wait time for tasks that started after their scheduled time.</span>

<span class="sd">        Average wait time provides insight into how long tasks are typically delayed after</span>
<span class="sd">        their scheduled start time. A lower average suggests better scheduling efficiency.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: avg_wait_time: The average wait time in minutes for all appointments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_wait_time</span> <span class="o">=</span> <span class="n">ScheduleSimulator</span><span class="o">.</span><span class="n">_calculate_total_wait_time</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
        <span class="n">num_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_wait_time</span> <span class="o">/</span> <span class="n">num_tasks</span> <span class="k">if</span> <span class="n">num_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_task_completion_rate</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the task completion rate based on actual start and end times.</span>
<span class="sd">        Task completion rate indicates the percentage of scheduled tasks that were completed successfully,</span>
<span class="sd">        defined as having both an actual start and end time recorded. Higher rates reflect better operational efficiency.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>
<span class="sd">        :return: task_completion_rate: The percentage of tasks that were completed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_tasks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_df</span><span class="p">)</span>
        <span class="n">completed_tasks</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">completed_tasks</span> <span class="o">/</span> <span class="n">total_tasks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_makespan</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the makespan of all tasks, which is the total time from the start of the first task</span>
<span class="sd">        to the completion of the last task.</span>
<span class="sd">        Makespan is a crucial measure in scheduling as it represents the total time required to complete a set of tasks.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>
<span class="sd">        :return: makespan: The total duration from the start of the first task to the end of the last task in minutes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">end_times</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">end_times</span> <span class="o">-</span> <span class="n">start_times</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">end_times</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_overutilization_rate</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the overutilization rate for machines, indicating the percentage of time machines were</span>
<span class="sd">        utilized above their scheduled capacity.</span>
<span class="sd">        Overutilization can signal operational inefficiencies and is an important metric to monitor for resource management.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>
<span class="sd">        :return: overutilization_rate: The percentage of time machines were overutilized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_overutilized_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">machine_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">machine</span><span class="p">]</span>

            <span class="n">scheduled_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="n">total_time</span> <span class="o">+=</span> <span class="n">scheduled_duration</span>

            <span class="n">actual_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

            <span class="k">if</span> <span class="n">actual_duration</span> <span class="o">&gt;</span> <span class="n">scheduled_duration</span><span class="p">:</span>
                <span class="n">overutilized_time</span> <span class="o">=</span> <span class="n">actual_duration</span> <span class="o">-</span> <span class="n">scheduled_duration</span>
                <span class="n">total_overutilized_time</span> <span class="o">+=</span> <span class="n">overutilized_time</span>

        <span class="n">overutilization_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_overutilized_time</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">overutilization_rate</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_underutilization_rate</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the underutilization rate for machines, indicating the percentage of time machines were</span>
<span class="sd">        not utilized to their full potential.</span>

<span class="sd">        Underutilization can indicate inefficiencies and potential for improved scheduling.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: underutilization_rate: The percentage of time machines were underutilized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_underutilized_time</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">machine_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">machine</span><span class="p">]</span>

            <span class="n">scheduled_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
            <span class="n">total_time</span> <span class="o">+=</span> <span class="n">scheduled_duration</span>

            <span class="n">actual_duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">machine_df</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>

            <span class="k">if</span> <span class="n">actual_duration</span> <span class="o">&lt;</span> <span class="n">scheduled_duration</span><span class="p">:</span>
                <span class="n">underutilized_time</span> <span class="o">=</span> <span class="n">scheduled_duration</span> <span class="o">-</span> <span class="n">actual_duration</span>
                <span class="n">total_underutilized_time</span> <span class="o">+=</span> <span class="n">underutilized_time</span>

        <span class="n">underutilization_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_underutilized_time</span> <span class="o">/</span> <span class="n">total_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">underutilization_rate</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_load_balancing_efficiency</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate load balancing efficiency, measuring how evenly tasks are distributed across machines.</span>

<span class="sd">        Load balancing efficiency indicates the proportion of time that machines are utilized effectively,</span>
<span class="sd">        which is crucial for optimizing scheduling and resource allocation.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: load_balancing_efficiency: The efficiency of load balancing across machines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">machine_loads</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;actual_start&#39;</span><span class="p">:</span> <span class="s1">&#39;count&#39;</span><span class="p">})</span>
        <span class="n">avg_load</span> <span class="o">=</span> <span class="n">machine_loads</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">load_balancing_efficiency</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">machine_loads</span> <span class="o">-</span> <span class="n">avg_load</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">avg_load</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">machine_loads</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">load_balancing_efficiency</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_task_bumping_rate</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the task bumping rate, indicating how often tasks are rescheduled or delayed.</span>

<span class="sd">        Task bumping rate is important for understanding scheduling efficiency and the impact of delays on workflow.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: task_bumping_rate: The percentage of tasks that experienced bumping or rescheduling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bumped_tasks</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">total_tasks</span> <span class="o">=</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">task_bumping_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bumped_tasks</span> <span class="o">/</span> <span class="n">total_tasks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_tasks</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">task_bumping_rate</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_jitter</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the jitter, which measures the variability in start times for scheduled tasks.</span>

<span class="sd">        A lower jitter indicates more consistent scheduling, while a higher jitter suggests variability and potential inefficiencies.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: jitter: The standard deviation of start times from the mean in minutes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">actual_start_times</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="s1">&#39;actual_start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">actual_start_times</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">actual_start_times</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">jitter</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_calculate_end_time_deviation</span><span class="p">(</span><span class="n">merged_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the end time deviation, which measures the difference between scheduled and actual end times.</span>

<span class="sd">        End time deviation provides insights into how accurately tasks are completed within their planned durations.</span>

<span class="sd">        :param merged_df: Merged DataFrame of scheduled and actual times.</span>

<span class="sd">        :return: end_time_deviation: The average deviation of actual end times from scheduled end times in minutes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deviations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">scheduled_end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span>
            <span class="n">actual_end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;actual_end&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">actual_end</span><span class="p">):</span>
                <span class="n">deviation</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_end</span> <span class="o">-</span> <span class="n">scheduled_end</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span>
                <span class="n">deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deviation</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">deviations</span><span class="p">)</span> <span class="k">if</span> <span class="n">deviations</span> <span class="k">else</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="simulator.ScheduleSimulator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Initialize the simulator with a scheduling model.</p>
<p>:param model: A function that returns a DataFrame with scheduled appointments.
              The DataFrame should have columns ['appointment_id', 'machine', 'start_time', 'end_time'].</p>

            <details class="quote">
              <summary>Source code in <code>simulator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the simulator with a scheduling model.</span>

<span class="sd">    :param model: A function that returns a DataFrame with scheduled appointments.</span>
<span class="sd">                  The DataFrame should have columns [&#39;appointment_id&#39;, &#39;machine&#39;, &#39;start_time&#39;, &#39;end_time&#39;].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To hold the schedule once it&#39;s generated</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># To hold performance metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="simulator.ScheduleSimulator.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">appointments</span><span class="p">,</span> <span class="n">actual_durations</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the simulation, scheduling the appointments and calculating performance metrics.</p>
<p>:param appointments: DataFrame of appointments (only has 'appointment_id' and 'machine').
                    The start and end times will be filled in by the model.
:param actual_durations: DataFrame of the actual durations for each machine.
                         It should have columns ['appointment_id', 'machine', 'duration'].</p>
<p>:return: results: Dictionary of performance metrics in a DataFrame format.</p>

            <details class="quote">
              <summary>Source code in <code>simulator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appointments</span><span class="p">,</span> <span class="n">actual_durations</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the simulation, scheduling the appointments and calculating performance metrics.</span>

<span class="sd">    :param appointments: DataFrame of appointments (only has &#39;appointment_id&#39; and &#39;machine&#39;).</span>
<span class="sd">                        The start and end times will be filled in by the model.</span>
<span class="sd">    :param actual_durations: DataFrame of the actual durations for each machine.</span>
<span class="sd">                             It should have columns [&#39;appointment_id&#39;, &#39;machine&#39;, &#39;duration&#39;].</span>

<span class="sd">    :return: results: Dictionary of performance metrics in a DataFrame format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate the schedule using the model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">appointments</span><span class="p">)</span>

    <span class="c1"># Merge appointments with actual durations</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">actual_durations</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;appointment_id&#39;</span><span class="p">,</span> <span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate the actual start and end times</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_actual_times</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>

    <span class="c1"># Metrics Calculation</span>
    <span class="n">utilization</span><span class="p">,</span> <span class="n">idle_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_utilization</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">scheduling_accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_scheduling_accuracy</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">total_wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_total_wait_time</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">avg_wait_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_average_wait_time</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">task_completion_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_task_completion_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">makespan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_makespan</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">overutilization_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_overutilization_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">underutilization_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_underutilization_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">load_balancing_efficiency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_load_balancing_efficiency</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">task_bumping_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_task_bumping_rate</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">jitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_jitter</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="n">end_time_deviation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_end_time_deviation</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>

    <span class="c1"># Store the results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;utilization&#39;</span><span class="p">:</span> <span class="n">utilization</span><span class="p">,</span>
        <span class="s1">&#39;idle_time&#39;</span><span class="p">:</span> <span class="n">idle_time</span><span class="p">,</span>
        <span class="s1">&#39;scheduling_accuracy&#39;</span><span class="p">:</span> <span class="n">scheduling_accuracy</span><span class="p">,</span>
        <span class="s1">&#39;total_wait_time&#39;</span><span class="p">:</span> <span class="n">total_wait_time</span><span class="p">,</span>
        <span class="s1">&#39;average_wait_time&#39;</span><span class="p">:</span> <span class="n">avg_wait_time</span><span class="p">,</span>
        <span class="s1">&#39;task_completion_rate&#39;</span><span class="p">:</span> <span class="n">task_completion_rate</span><span class="p">,</span>
        <span class="s1">&#39;makespan&#39;</span><span class="p">:</span> <span class="n">makespan</span><span class="p">,</span>
        <span class="s1">&#39;overutilization_rate&#39;</span><span class="p">:</span> <span class="n">overutilization_rate</span><span class="p">,</span>
        <span class="s1">&#39;underutilization_rate&#39;</span><span class="p">:</span> <span class="n">underutilization_rate</span><span class="p">,</span>
        <span class="s1">&#39;load_balancing_efficiency&#39;</span><span class="p">:</span> <span class="n">load_balancing_efficiency</span><span class="p">,</span>
        <span class="s1">&#39;task_bumping_rate&#39;</span><span class="p">:</span> <span class="n">task_bumping_rate</span><span class="p">,</span>
        <span class="s1">&#39;jitter&#39;</span><span class="p">:</span> <span class="n">jitter</span><span class="p">,</span>
        <span class="s1">&#39;end_time_deviation&#39;</span><span class="p">:</span> <span class="n">end_time_deviation</span>
    <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Metric&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

<!--
MkDocs version : 1.6.1
Build Date UTC : 2024-11-11 15:39:54.345206+00:00
-->
